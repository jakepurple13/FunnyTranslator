name: Release Workflow

on:
  push:
    tags:
      - 'v*'
    paths-ignore:
      - '.github/**'

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android:
    uses: ./.github/workflows/android_build.yml
    secrets: inherit # pass all secrets
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-android
      cancel-in-progress: true

  desktop:
    uses: ./.github/workflows/desktop_build.yml
    secrets: inherit # pass all secrets
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-desktop
      cancel-in-progress: true

  web:
    uses: ./.github/workflows/wasm_build.yml
    secrets: inherit # pass all secrets
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-web
      cancel-in-progress: true

  deploy:
    # Add a dependency to the build job
    needs: web

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Specify runner + deployment step
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    name: Release Artifacts
    needs: [ android, desktop ]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: echo
        run:
          ls * -r

      - name: Get tag name
        id: get_tag_name
        run: |
          set -x
          echo "VERSION_TAG=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ env.VERSION_TAG }}
          name: Release ${{ env.VERSION_TAG }}
          files: |
            ${{ github.workspace }}/release-artifacts/**